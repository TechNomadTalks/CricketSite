<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Cricket Arena</title>
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="cricket-favicon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="cricket-icon-192.png">
    <link rel="apple-touch-icon" href="cricket-icon-192.png">
    <meta name="theme-color" content="#1B5E20">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .admin-login {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1B5E20, #FFC107);
        }
        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 450px;
            width: 100%;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1B5E20;
        }
        .table-responsive {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }
        .status-confirmed {
            background-color: #D4EDDA;
            color: #155724;
        }
        .status-cancelled {
            background-color: #F8D7DA;
            color: #721C24;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="admin-login">
        <div class="login-card">
            <div class="text-center mb-4">
                <img src="coastal-accounting-logo.png" alt="Cricket Arena" style="height: 60px;" class="mb-3">
                <h2>Admin Login</h2>
                <p class="text-muted">Cricket Arena Booking Management</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login
                </button>
                <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" style="display: none;">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h2>
                        <p class="mb-0">Cricket Arena Booking Management</p>
                    </div>
                    <div>
                        <span class="me-3" id="adminEmail"></span>
                        <button class="btn btn-light" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="container-fluid mb-5">
            <!-- Statistics Row -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="bi bi-calendar-check text-success mb-2" style="font-size: 2rem;"></i>
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="text-muted">Total Bookings</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="bi bi-clock-history text-warning mb-2" style="font-size: 2rem;"></i>
                        <div class="stat-number" id="statPending">0</div>
                        <div class="text-muted">Pending</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="bi bi-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                        <div class="stat-number" id="statConfirmed">0</div>
                        <div class="text-muted">Confirmed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="bi bi-x-circle text-danger mb-2" style="font-size: 2rem;"></i>
                        <div class="stat-number" id="statCancelled">0</div>
                        <div class="text-muted">Cancelled</div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="table-responsive">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>All Bookings</h4>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="filterStatus" style="width: auto;">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <button class="btn btn-sm btn-primary" onclick="refreshBookings()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        
                        <table class="table table-hover" id="bookingsTable">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Customer</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTableBody">
                                <tr>
                                    <td colspan="10" class="text-center text-muted">No bookings found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="config.js"></script>
    
    <!-- Admin Dashboard Script -->
    <script>
        let currentUser = null;
        let allBookings = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupLoginForm();
            setupFilters();
        });

        // Check if user is already authenticated
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showDashboard();
                loadBookings();
            }
        }

        // Setup login form
        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    currentUser = data.user;
                    showDashboard();
                    loadBookings();
                } catch (error) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = error.message;
                }
            });
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('adminEmail').textContent = currentUser.email;
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // Load bookings
        async function loadBookings() {
            const filterStatus = document.getElementById('filterStatus').value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const tableBody = document.getElementById('bookingsTableBody');
            
            loadingSpinner.style.display = 'block';
            
            try {
                let url = CONFIG.EDGE_FUNCTIONS.GET_BOOKINGS;
                if (filterStatus !== 'all') {
                    url += `?status=${filterStatus}`;
                }
                
                const { data: session } = await supabase.auth.getSession();
                
                const { data, error } = await supabase.functions.invoke('get-bookings', {
                    headers: {
                        Authorization: `Bearer ${session.session.access_token}`
                    }
                });
                
                if (error) throw error;
                
                allBookings = data.data.bookings;
                renderBookings(allBookings);
                updateStats(allBookings);
            } catch (error) {
                console.error('Error loading bookings:', error);
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error loading bookings: ${error.message}</td></tr>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // SECURITY: Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#x27;',
                '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'\/]/g, (char) => map[char]);
        }

        // Render bookings in table with XSS protection
        function renderBookings(bookings) {
            const tableBody = document.getElementById('bookingsTableBody');
            
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No bookings found</td></tr>';
                return;
            }
            
            // SECURITY FIX: Use escapeHtml on all user-provided data
            tableBody.innerHTML = bookings.map(booking => `
                <tr>
                    <td><code>${escapeHtml(booking.id.substring(0, 8))}</code></td>
                    <td>${escapeHtml(booking.customer_name)}</td>
                    <td>${escapeHtml(booking.email)}</td>
                    <td>${escapeHtml(booking.phone)}</td>
                    <td>${escapeHtml(booking.booking_date)}</td>
                    <td>${escapeHtml(booking.time_slot)}</td>
                    <td>${escapeHtml(booking.duration)}h</td>
                    <td>R ${escapeHtml(booking.total_price)}</td>
                    <td><span class="status-badge status-${escapeHtml(booking.status)}">${escapeHtml(booking.status.toUpperCase())}</span></td>
                    <td>
                        ${booking.status === 'pending' ? `
                            <button class="btn btn-sm btn-success me-1" onclick="updateStatus('${escapeHtml(booking.id)}', 'confirmed')" title="Confirm Booking">
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger me-1" onclick="updateStatus('${escapeHtml(booking.id)}', 'cancelled')" title="Cancel Booking">
                                <i class="bi bi-x"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-primary" onclick="openModifyModal('${escapeHtml(booking.id)}', '${escapeHtml(booking.customer_name)}', '${escapeHtml(booking.booking_date)}', '${escapeHtml(booking.time_slot)}', ${escapeHtml(booking.duration)})" title="Modify Booking">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStats(bookings) {
            document.getElementById('statTotal').textContent = bookings.length;
            document.getElementById('statPending').textContent = bookings.filter(b => b.status === 'pending').length;
            document.getElementById('statConfirmed').textContent = bookings.filter(b => b.status === 'confirmed').length;
            document.getElementById('statCancelled').textContent = bookings.filter(b => b.status === 'cancelled').length;
        }

        // Update booking status
        async function updateStatus(bookingId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus} this booking?`)) {
                return;
            }
            
            try {
                const { data: session } = await supabase.auth.getSession();
                
                const { data, error } = await supabase.functions.invoke('update-booking-status', {
                    body: {
                        booking_id: bookingId,
                        status: newStatus
                    },
                    headers: {
                        Authorization: `Bearer ${session.session.access_token}`
                    }
                });
                
                if (error) throw error;
                
                showToast(`Booking ${newStatus} successfully!`, 'success');
                loadBookings();
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error updating booking status: ' + error.message, 'error');
            }
        }

        // Setup filters
        function setupFilters() {
            document.getElementById('filterStatus').addEventListener('change', loadBookings);
        }

        // Refresh bookings
        function refreshBookings() {
            loadBookings();
        }

        // Open modify booking modal
        function openModifyModal(bookingId, customerName, currentDate, currentTime, currentDuration) {
            document.getElementById('modifyBookingId').value = bookingId;
            document.getElementById('modifyCustomerName').textContent = customerName;
            document.getElementById('currentDate').value = currentDate;
            document.getElementById('currentTime').value = currentTime;
            document.getElementById('currentDuration').value = currentDuration + ' hours';
            
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('newDate').min = tomorrow.toISOString().split('T')[0];
            
            // Populate time slots
            const timeSlotSelect = document.getElementById('newTimeSlot');
            timeSlotSelect.innerHTML = '<option value="">Select time</option>';
            CONFIG.TIME_SLOTS.forEach(slot => {
                timeSlotSelect.innerHTML += `<option value="${slot.value}">${slot.label}</option>`;
            });
            
            // Clear form
            document.getElementById('newDate').value = '';
            document.getElementById('newTimeSlot').value = '';
            document.getElementById('newDuration').value = '';
            document.getElementById('adminReason').value = '';
            document.getElementById('modifyError').style.display = 'none';
            
            // Show modal
            new bootstrap.Modal(document.getElementById('modifyBookingModal')).show();
        }

        // Submit modify booking
        async function submitModifyBooking() {
            const bookingId = document.getElementById('modifyBookingId').value;
            const newDate = document.getElementById('newDate').value;
            const newTimeSlot = document.getElementById('newTimeSlot').value;
            const newDuration = parseInt(document.getElementById('newDuration').value);
            const adminReason = document.getElementById('adminReason').value;
            const errorDiv = document.getElementById('modifyError');
            
            // Validate form
            if (!newDate || !newTimeSlot || !newDuration) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please fill in all required fields.';
                return;
            }
            
            try {
                const { data: session } = await supabase.auth.getSession();
                
                const { data, error } = await supabase.functions.invoke('modify-booking', {
                    body: {
                        booking_id: bookingId,
                        new_date: newDate,
                        new_time_slot: newTimeSlot,
                        new_duration: newDuration,
                        admin_reason: adminReason
                    },
                    headers: {
                        Authorization: `Bearer ${session.session.access_token}`
                    }
                });
                
                if (error) throw error;
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('modifyBookingModal')).hide();
                
                // Show success message
                showToast('Booking modified successfully! Customer has been notified.', 'success');
                
                // Refresh bookings
                loadBookings();
            } catch (error) {
                console.error('Error modifying booking:', error);
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error modifying booking: ' + error.message;
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
            
            const toastHtml = `
                <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Create toast container if it doesn't exist
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }
    </script>

    <!-- Modify Booking Modal -->
    <div class="modal fade" id="modifyBookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Modify Booking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="modifyBookingForm">
                        <input type="hidden" id="modifyBookingId">
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Customer: <strong id="modifyCustomerName"></strong>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Date</label>
                                    <input type="text" class="form-control" id="currentDate" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">New Date</label>
                                    <input type="date" class="form-control" id="newDate" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Time</label>
                                    <input type="text" class="form-control" id="currentTime" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">New Time</label>
                                    <select class="form-select" id="newTimeSlot" required>
                                        <option value="">Select time</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Duration</label>
                                    <input type="text" class="form-control" id="currentDuration" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">New Duration (hours)</label>
                                    <select class="form-select" id="newDuration" required>
                                        <option value="">Select hours</option>
                                        <option value="1">1 hour</option>
                                        <option value="2">2 hours</option>
                                        <option value="3">3 hours</option>
                                        <option value="4">4 hours</option>
                                        <option value="5">5 hours</option>
                                        <option value="6">6 hours</option>
                                        <option value="7">7 hours</option>
                                        <option value="8">8 hours</option>
                                        <option value="9">9 hours</option>
                                        <option value="10">10 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Reason for Change (Optional)</label>
                            <textarea class="form-control" id="adminReason" rows="3" placeholder="Explain why the booking is being modified..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> The customer will be notified via email about this change.
                            Bookings within 1-2 days of the scheduled date cannot be modified.
                        </div>
                        
                        <div id="modifyError" class="alert alert-danger" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitModifyBooking()">
                        <i class="bi bi-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>
</body>
</html>
